<html>

  <style>
    body {
      background: silver;
      @media screen and (min-width: 414px) {
        width: 414px;
      }
      border: 3px solid black;
      padding: 10px;
      display: grid;
      grid-template-rows: auto 1fr;
      font-family: system-ui;

      > div:nth-child(2) {
        display: grid;
      }
    }
    button {
      width: calc(100% - 20px);
      height: 60px;
      font-size: x-large;
      border: 2px solid black;
      border-radius: 10px;
      margin: 10px;
    }
  </style>

  <script>
    window.onload = () => { init() }
    init = () => {
      installSW()

      //  通知の許可を求める。
      //  途中のステップをアラートで可視化。
      button_confirm.addEventListener("click", (e) => {
        alert("START")
        //  環境が通知に対応しているか？
        if("Notification" in window) {
          alert("この環境には通知機能があります。 Notification is here.")
        } else {
          alert("この環境には通知機能がありません。 Notification is nothing...")
        }
        //  通知の許可を求める。
        Notification.requestPermission()
        .then((result) => {
          alert(`Permission state : ${result}`)
        })
        .catch((result) => {
          alert(`CATCH : ${result}`)
        })
        .finally(() => {
          alert("END")
        })
      })

      //  実際に通知を飛ばす。
      button_notification.addEventListener("click", (e) => {
        alert("START")
//        alert("case1:")
//        //  MacBook Chrome 上では、コレでローカル通知が出る。
//        //  2023.05.11 確認結果
//        //    Mac Chrome: 通知でた
//        //    Mac Safari: 通知でた
//        //    iPhone PWA: 通知でない
//        new Notification("For Mac Chrome!")


//        alert("case2:")
//        // iPhone PWA 上では、コレでローカル通知が出る。
//        // 振動はしなかった。
//        //  2023.05.11 確認結果
//        //    Mac Chrome: 通知でた
//        //    Mac Safari: 通知でた
//        //    iPhone PWA: 通知でた
//        navigator.serviceWorker.ready.then((registration) => {
//          registration.showNotification("バイブレーションの例", {
//            body: "For iPhone!",
//            icon: "../images/touch/chrome-touch-icon-192x192.png",
//            vibrate: [200, 100, 200, 100, 200, 100, 200],
//            tag: "vibration-sample",
//          });
//        });

//        alert("case3:")
//        //  これはどの環境でも動かなかった。ボツ。
//        self.registration.showNotification("SHOW!")

        alert("case4:")
        const channel = new MessageChannel()
        alert(navigator.serviceWorker.controller)
        navigator.serviceWorker.controller.postMessage('Hi! You are service worker.', [channel.port2])
        alert("END")
      })

      //  画面の更新。PWAはブラウザみたいにさっとリロードする導線ないので作った。
      button_reload.addEventListener("click", (e) => {
        location.reload()
      })
    }

    //  サービスワーカーをインストールする。
    installSW = () => {
      if('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
        .then(() => {
            console.log("Service Worker Registered.")
          }
        )
        .finally(() => {
            console.log("Service Worker Finished.")
        })
      }
    }

  </script>

  <head>
    <link href="./manifest.webmanifest" rel="manifest">
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
  </head>
  <body>
    <div>
      <h1> iPhone iOS16.4以上用 </h1>
      <h2> PWAローカル通知 動作検証ページ </h2>

      <p>
        Written by: Neji.bit ( Twitter: @Neji83808822 )
      </p>

      <h3> はじめに： </h3>
      <p>
        上記の環境で、PWAからiPhoneに「ローカル通知」を送れるか？を検証するページです。
      </p>

      <h3> 確認方法： </h3>
      <ul>
        <li> 上から順にボタンを押して行ってください。
        <li> 「うまくいく環境」であれば、iPhone上で通知が飛びます。
      </ul>

      <h3> ポイント： </h3>
      <ul>
        <li> 「通知の許可を求めるタイミング」には注意点があるよ。
          <ul>
            <li> window.onload の中で Notification.requestPermission() をしても効かない。
              <ul>
                <li> （MacBook上の Safari, Chrome では効くのにiPhoneだと効かない）
                <li> iPhoneの場合は、このページのように「ボタンクリック等のアクションに紐付いて」通知の許可を求めればOK。
              </ul>
          </ul>
        <li> 「リマインダー通知」等は、サーバなしでPWA自力で通知できるよ。
      </ul>
    </div>


2023年 5月11日 木曜日 17時29分44秒 JST
    <div>
      <div>
        <button id="button_confirm">
          通知の許可を求めるよ！
        </button>
      </div>
      <div>
        <button id="button_notification">
          ローカルで通知を送るよ！
        </button>
      </div>
      <div>
        <button id="button_reload">
          画面をリロードするよ！
        </button>
      </div>
    </div>
    <div>
      <h3>このページのURL</h3>
      <img src="./qr.png"/>
    </div>
  </body>
</html>
